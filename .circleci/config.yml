version: 2
jobs:
  test:
    docker:
      - image: docker:17.12
    steps:
      - checkout
      - setup_remote_docker
#      - setup_remote_docker:
#          docker_layer_caching: true
      - run:
          name: Run tests
          command: |
            docker build -q --file ./Dockerfile.test --tag quay.io/kfirs/deployster:test-${CIRCLE_SHA1} .
            docker run --env COVERALLS_REPO_TOKEN="${COVERALLS_REPO_TOKEN}" \
                       --env CIRCLECI="${CIRCLECI}" \
                       --env CIRCLE_BUILD_NUM="${CIRCLE_BUILD_NUM}" \
                       --env CIRCLE_BRANCH="${CIRCLE_BRANCH}" \
                       --env CI_PULL_REQUEST="${CI_PULL_REQUEST}" \
                       --tty \
                       quay.io/kfirs/deployster:test-${CIRCLE_SHA1} \
                       $@
  build:
    docker:
      - image: docker:17.12
    steps:
      - checkout
      - setup_remote_docker
#      - setup_remote_docker:
#          docker_layer_caching: true
      - run:
          name: Login to quay.io
          command: |
            echo "${QUAY_ACCESS_TOKEN}" | docker login -u="kfirs+circleci" --password-stdin quay.io
      - run:
          name: Update FROM directives in Dockerfile(s)
          command: |
            for file in $(ls -X $(pwd)/resources/Dockerfile.*|grep -v ".local"); do
                sed -i "s/^FROM \(quay.io\/kfirs\/deployster-[^:]\+\):.\+$/FROM \1:${CIRCLE_SHA1}/g" "${file}"
            done
      - run:
          name: Build Docker images (commit SHA)
          command: |
            docker build -q --tag quay.io/kfirs/deployster-dresource:${CIRCLE_SHA1} -f ./resources/Dockerfile.dresource ./resources
            docker build -q --tag quay.io/kfirs/deployster-gcp:${CIRCLE_SHA1} -f ./resources/Dockerfile.gcp ./resources
            docker build -q --tag quay.io/kfirs/deployster-gcp-cloud-sql:${CIRCLE_SHA1} -f ./resources/Dockerfile.gcp_cloud_sql ./resources
            docker build -q --tag quay.io/kfirs/deployster-gcp-compute-ip-address:${CIRCLE_SHA1} -f ./resources/Dockerfile.gcp_compute_ip_address ./resources
            docker build -q --tag quay.io/kfirs/deployster-gcp-gke-cluster:${CIRCLE_SHA1} -f ./resources/Dockerfile.gcp_gke_cluster ./resources
            docker build -q --tag quay.io/kfirs/deployster-gcp-iam-policy:${CIRCLE_SHA1} -f ./resources/Dockerfile.gcp_iam_service_account ./resources
            docker build -q --tag quay.io/kfirs/deployster-gcp-iam-service-account:${CIRCLE_SHA1} -f ./resources/Dockerfile.gcp_iam_policy ./resources
            docker build -q --tag quay.io/kfirs/deployster-gcp-project:${CIRCLE_SHA1} -f ./resources/Dockerfile.gcp_project ./resources
            docker build -q --tag quay.io/kfirs/deployster-k8s:${CIRCLE_SHA1} -f ./resources/Dockerfile.k8s ./resources
            docker build -q --build-arg "VERSION=${CIRCLE_SHA1}" --tag quay.io/kfirs/deployster:${CIRCLE_SHA1} -f ./Dockerfile .
            docker tag quay.io/kfirs/deployster-k8s:${CIRCLE_SHA1} quay.io/kfirs/deployster-k8s-clusterrole:${CIRCLE_SHA1}
            docker tag quay.io/kfirs/deployster-k8s:${CIRCLE_SHA1} quay.io/kfirs/deployster-k8s-clusterrolebinding:${CIRCLE_SHA1}
            docker tag quay.io/kfirs/deployster-k8s:${CIRCLE_SHA1} quay.io/kfirs/deployster-k8s-configmap:${CIRCLE_SHA1}
            docker tag quay.io/kfirs/deployster-k8s:${CIRCLE_SHA1} quay.io/kfirs/deployster-k8s-cronjob:${CIRCLE_SHA1}
            docker tag quay.io/kfirs/deployster-k8s:${CIRCLE_SHA1} quay.io/kfirs/deployster-k8s-daemonset:${CIRCLE_SHA1}
            docker tag quay.io/kfirs/deployster-k8s:${CIRCLE_SHA1} quay.io/kfirs/deployster-k8s-deployment:${CIRCLE_SHA1}
            docker tag quay.io/kfirs/deployster-k8s:${CIRCLE_SHA1} quay.io/kfirs/deployster-k8s-horizontalpodautoscaler:${CIRCLE_SHA1}
            docker tag quay.io/kfirs/deployster-k8s:${CIRCLE_SHA1} quay.io/kfirs/deployster-k8s-ingress:${CIRCLE_SHA1}
            docker tag quay.io/kfirs/deployster-k8s:${CIRCLE_SHA1} quay.io/kfirs/deployster-k8s-job:${CIRCLE_SHA1}
            docker tag quay.io/kfirs/deployster-k8s:${CIRCLE_SHA1} quay.io/kfirs/deployster-k8s-namespace:${CIRCLE_SHA1}
            docker tag quay.io/kfirs/deployster-k8s:${CIRCLE_SHA1} quay.io/kfirs/deployster-k8s-networkpolicy:${CIRCLE_SHA1}
            docker tag quay.io/kfirs/deployster-k8s:${CIRCLE_SHA1} quay.io/kfirs/deployster-k8s-node:${CIRCLE_SHA1}
            docker tag quay.io/kfirs/deployster-k8s:${CIRCLE_SHA1} quay.io/kfirs/deployster-k8s-persistentvolume:${CIRCLE_SHA1}
            docker tag quay.io/kfirs/deployster-k8s:${CIRCLE_SHA1} quay.io/kfirs/deployster-k8s-persistentvolumeclaim:${CIRCLE_SHA1}
            docker tag quay.io/kfirs/deployster-k8s:${CIRCLE_SHA1} quay.io/kfirs/deployster-k8s-pod:${CIRCLE_SHA1}
            docker tag quay.io/kfirs/deployster-k8s:${CIRCLE_SHA1} quay.io/kfirs/deployster-k8s-replicaset:${CIRCLE_SHA1}
            docker tag quay.io/kfirs/deployster-k8s:${CIRCLE_SHA1} quay.io/kfirs/deployster-k8s-replicationcontroller:${CIRCLE_SHA1}
            docker tag quay.io/kfirs/deployster-k8s:${CIRCLE_SHA1} quay.io/kfirs/deployster-k8s-role:${CIRCLE_SHA1}
            docker tag quay.io/kfirs/deployster-k8s:${CIRCLE_SHA1} quay.io/kfirs/deployster-k8s-rolebinding:${CIRCLE_SHA1}
            docker tag quay.io/kfirs/deployster-k8s:${CIRCLE_SHA1} quay.io/kfirs/deployster-k8s-secret:${CIRCLE_SHA1}
            docker tag quay.io/kfirs/deployster-k8s:${CIRCLE_SHA1} quay.io/kfirs/deployster-k8s-service:${CIRCLE_SHA1}
            docker tag quay.io/kfirs/deployster-k8s:${CIRCLE_SHA1} quay.io/kfirs/deployster-k8s-serviceaccount:${CIRCLE_SHA1}
            docker tag quay.io/kfirs/deployster-k8s:${CIRCLE_SHA1} quay.io/kfirs/deployster-k8s-statefulset:${CIRCLE_SHA1}
            docker tag quay.io/kfirs/deployster-k8s:${CIRCLE_SHA1} quay.io/kfirs/deployster-k8s-storageclass:${CIRCLE_SHA1}
      - run:
          name: Push Docker images (commit SHA)
          command: |
            docker push quay.io/kfirs/deployster-dresource:${CIRCLE_SHA1} &
            docker push quay.io/kfirs/deployster-gcp:${CIRCLE_SHA1} &
            docker push quay.io/kfirs/deployster-gcp-cloud-sql:${CIRCLE_SHA1} &
            docker push quay.io/kfirs/deployster-gcp-compute-ip-address:${CIRCLE_SHA1} &
            docker push quay.io/kfirs/deployster-gcp-gke-cluster:${CIRCLE_SHA1} &
            docker push quay.io/kfirs/deployster-gcp-iam-policy:${CIRCLE_SHA1} &
            docker push quay.io/kfirs/deployster-gcp-iam-service-account:${CIRCLE_SHA1} &
            docker push quay.io/kfirs/deployster-gcp-project:${CIRCLE_SHA1} &
            docker push quay.io/kfirs/deployster-k8s:${CIRCLE_SHA1} &
            docker push quay.io/kfirs/deployster-k8s-clusterrole:${CIRCLE_SHA1} &
            docker push quay.io/kfirs/deployster-k8s-clusterrolebinding:${CIRCLE_SHA1} &
            docker push quay.io/kfirs/deployster-k8s-configmap:${CIRCLE_SHA1} &
            docker push quay.io/kfirs/deployster-k8s-cronjob:${CIRCLE_SHA1} &
            docker push quay.io/kfirs/deployster-k8s-daemonset:${CIRCLE_SHA1} &
            docker push quay.io/kfirs/deployster-k8s-deployment:${CIRCLE_SHA1} &
            docker push quay.io/kfirs/deployster-k8s-horizontalpodautoscaler:${CIRCLE_SHA1} &
            docker push quay.io/kfirs/deployster-k8s-ingress:${CIRCLE_SHA1} &
            docker push quay.io/kfirs/deployster-k8s-job:${CIRCLE_SHA1} &
            docker push quay.io/kfirs/deployster-k8s-namespace:${CIRCLE_SHA1} &
            docker push quay.io/kfirs/deployster-k8s-networkpolicy:${CIRCLE_SHA1} &
            docker push quay.io/kfirs/deployster-k8s-node:${CIRCLE_SHA1} &
            docker push quay.io/kfirs/deployster-k8s-persistentvolume:${CIRCLE_SHA1} &
            docker push quay.io/kfirs/deployster-k8s-persistentvolumeclaim:${CIRCLE_SHA1} &
            docker push quay.io/kfirs/deployster-k8s-pod:${CIRCLE_SHA1} &
            docker push quay.io/kfirs/deployster-k8s-replicaset:${CIRCLE_SHA1} &
            docker push quay.io/kfirs/deployster-k8s-replicationcontroller:${CIRCLE_SHA1} &
            docker push quay.io/kfirs/deployster-k8s-role:${CIRCLE_SHA1} &
            docker push quay.io/kfirs/deployster-k8s-rolebinding:${CIRCLE_SHA1} &
            docker push quay.io/kfirs/deployster-k8s-secret:${CIRCLE_SHA1} &
            docker push quay.io/kfirs/deployster-k8s-service:${CIRCLE_SHA1} &
            docker push quay.io/kfirs/deployster-k8s-serviceaccount:${CIRCLE_SHA1} &
            docker push quay.io/kfirs/deployster-k8s-statefulset:${CIRCLE_SHA1} &
            docker push quay.io/kfirs/deployster-k8s-storageclass:${CIRCLE_SHA1} &
            docker push quay.io/kfirs/deployster:${CIRCLE_SHA1} &
            wait
  release:
    docker:
      - image: docker:17.12
    steps:
      - checkout
      - setup_remote_docker
#      - setup_remote_docker:
#          docker_layer_caching: true
      - run:
          name: Login to quay.io
          command: |
            echo "${QUAY_ACCESS_TOKEN}" | docker login -u="kfirs+circleci" --password-stdin quay.io
      - run:
          name: Pull SHA Docker images
          command: |
            docker pull quay.io/kfirs/deployster-dresource:${CIRCLE_SHA1} &
            docker pull quay.io/kfirs/deployster-gcp:${CIRCLE_SHA1} &
            docker pull quay.io/kfirs/deployster-gcp-cloud-sql:${CIRCLE_SHA1} &
            docker pull quay.io/kfirs/deployster-gcp-compute-ip-address:${CIRCLE_SHA1} &
            docker pull quay.io/kfirs/deployster-gcp-gke-cluster:${CIRCLE_SHA1} &
            docker pull quay.io/kfirs/deployster-gcp-iam-policy:${CIRCLE_SHA1} &
            docker pull quay.io/kfirs/deployster-gcp-iam-service-account:${CIRCLE_SHA1} &
            docker pull quay.io/kfirs/deployster-gcp-project:${CIRCLE_SHA1} &
            docker pull quay.io/kfirs/deployster-k8s:${CIRCLE_SHA1} &
            docker pull quay.io/kfirs/deployster-k8s-clusterrole:${CIRCLE_SHA1} &
            docker pull quay.io/kfirs/deployster-k8s-clusterrolebinding:${CIRCLE_SHA1} &
            docker pull quay.io/kfirs/deployster-k8s-configmap:${CIRCLE_SHA1} &
            docker pull quay.io/kfirs/deployster-k8s-cronjob:${CIRCLE_SHA1} &
            docker pull quay.io/kfirs/deployster-k8s-daemonset:${CIRCLE_SHA1} &
            docker pull quay.io/kfirs/deployster-k8s-deployment:${CIRCLE_SHA1} &
            docker pull quay.io/kfirs/deployster-k8s-horizontalpodautoscaler:${CIRCLE_SHA1} &
            docker pull quay.io/kfirs/deployster-k8s-ingress:${CIRCLE_SHA1} &
            docker pull quay.io/kfirs/deployster-k8s-job:${CIRCLE_SHA1} &
            docker pull quay.io/kfirs/deployster-k8s-namespace:${CIRCLE_SHA1} &
            docker pull quay.io/kfirs/deployster-k8s-networkpolicy:${CIRCLE_SHA1} &
            docker pull quay.io/kfirs/deployster-k8s-node:${CIRCLE_SHA1} &
            docker pull quay.io/kfirs/deployster-k8s-persistentvolume:${CIRCLE_SHA1} &
            docker pull quay.io/kfirs/deployster-k8s-persistentvolumeclaim:${CIRCLE_SHA1} &
            docker pull quay.io/kfirs/deployster-k8s-pod:${CIRCLE_SHA1} &
            docker pull quay.io/kfirs/deployster-k8s-replicaset:${CIRCLE_SHA1} &
            docker pull quay.io/kfirs/deployster-k8s-replicationcontroller:${CIRCLE_SHA1} &
            docker pull quay.io/kfirs/deployster-k8s-role:${CIRCLE_SHA1} &
            docker pull quay.io/kfirs/deployster-k8s-rolebinding:${CIRCLE_SHA1} &
            docker pull quay.io/kfirs/deployster-k8s-secret:${CIRCLE_SHA1} &
            docker pull quay.io/kfirs/deployster-k8s-service:${CIRCLE_SHA1} &
            docker pull quay.io/kfirs/deployster-k8s-serviceaccount:${CIRCLE_SHA1} &
            docker pull quay.io/kfirs/deployster-k8s-statefulset:${CIRCLE_SHA1} &
            docker pull quay.io/kfirs/deployster-k8s-storageclass:${CIRCLE_SHA1} &
            wait
      - run:
          name: Build versioned Docker images
          command: |
            docker tag quay.io/kfirs/deployster-dresource:${CIRCLE_SHA1} quay.io/kfirs/deployster-dresource:${CIRCLE_TAG}
            docker tag quay.io/kfirs/deployster-gcp:${CIRCLE_SHA1} quay.io/kfirs/deployster-gcp:${CIRCLE_TAG}
            docker tag quay.io/kfirs/deployster-gcp-cloud-sql:${CIRCLE_SHA1} quay.io/kfirs/deployster-gcp-cloud-sql:${CIRCLE_TAG}
            docker tag quay.io/kfirs/deployster-gcp-compute-ip-address:${CIRCLE_SHA1} quay.io/kfirs/deployster-gcp-compute-ip-address:${CIRCLE_TAG}
            docker tag quay.io/kfirs/deployster-gcp-gke-cluster:${CIRCLE_SHA1} quay.io/kfirs/deployster-gcp-gke-cluster:${CIRCLE_TAG}
            docker tag quay.io/kfirs/deployster-gcp-iam-policy:${CIRCLE_SHA1} quay.io/kfirs/deployster-gcp-iam-policy:${CIRCLE_TAG}
            docker tag quay.io/kfirs/deployster-gcp-iam-service-account:${CIRCLE_SHA1} quay.io/kfirs/deployster-gcp-iam-service-account:${CIRCLE_TAG}
            docker tag quay.io/kfirs/deployster-gcp-project:${CIRCLE_SHA1} quay.io/kfirs/deployster-gcp-project:${CIRCLE_TAG}
            docker tag quay.io/kfirs/deployster-k8s:${CIRCLE_SHA1} quay.io/kfirs/deployster-k8s:${CIRCLE_TAG}
            docker tag quay.io/kfirs/deployster-k8s-clusterrole:${CIRCLE_SHA1} quay.io/kfirs/deployster-k8s-clusterrole:${CIRCLE_TAG}
            docker tag quay.io/kfirs/deployster-k8s-clusterrolebinding:${CIRCLE_SHA1} quay.io/kfirs/deployster-k8s-clusterrolebinding:${CIRCLE_TAG}
            docker tag quay.io/kfirs/deployster-k8s-configmap:${CIRCLE_SHA1} quay.io/kfirs/deployster-k8s-configmap:${CIRCLE_TAG}
            docker tag quay.io/kfirs/deployster-k8s-cronjob:${CIRCLE_SHA1} quay.io/kfirs/deployster-k8s-cronjob:${CIRCLE_TAG}
            docker tag quay.io/kfirs/deployster-k8s-daemonset:${CIRCLE_SHA1} quay.io/kfirs/deployster-k8s-daemonset:${CIRCLE_TAG}
            docker tag quay.io/kfirs/deployster-k8s-deployment:${CIRCLE_SHA1} quay.io/kfirs/deployster-k8s-deployment:${CIRCLE_TAG}
            docker tag quay.io/kfirs/deployster-k8s-horizontalpodautoscaler:${CIRCLE_SHA1} quay.io/kfirs/deployster-k8s-horizontalpodautoscaler:${CIRCLE_TAG}
            docker tag quay.io/kfirs/deployster-k8s-ingress:${CIRCLE_SHA1} quay.io/kfirs/deployster-k8s-ingress:${CIRCLE_TAG}
            docker tag quay.io/kfirs/deployster-k8s-job:${CIRCLE_SHA1} quay.io/kfirs/deployster-k8s-job:${CIRCLE_TAG}
            docker tag quay.io/kfirs/deployster-k8s-namespace:${CIRCLE_SHA1} quay.io/kfirs/deployster-k8s-namespace:${CIRCLE_TAG}
            docker tag quay.io/kfirs/deployster-k8s-networkpolicy:${CIRCLE_SHA1} quay.io/kfirs/deployster-k8s-networkpolicy:${CIRCLE_TAG}
            docker tag quay.io/kfirs/deployster-k8s-node:${CIRCLE_SHA1} quay.io/kfirs/deployster-k8s-node:${CIRCLE_TAG}
            docker tag quay.io/kfirs/deployster-k8s-persistentvolume:${CIRCLE_SHA1} quay.io/kfirs/deployster-k8s-persistentvolume:${CIRCLE_TAG}
            docker tag quay.io/kfirs/deployster-k8s-persistentvolumeclaim:${CIRCLE_SHA1} quay.io/kfirs/deployster-k8s-persistentvolumeclaim:${CIRCLE_TAG}
            docker tag quay.io/kfirs/deployster-k8s-pod:${CIRCLE_SHA1} quay.io/kfirs/deployster-k8s-pod:${CIRCLE_TAG}
            docker tag quay.io/kfirs/deployster-k8s-replicaset:${CIRCLE_SHA1} quay.io/kfirs/deployster-k8s-replicaset:${CIRCLE_TAG}
            docker tag quay.io/kfirs/deployster-k8s-replicationcontroller:${CIRCLE_SHA1} quay.io/kfirs/deployster-k8s-replicationcontroller:${CIRCLE_TAG}
            docker tag quay.io/kfirs/deployster-k8s-role:${CIRCLE_SHA1} quay.io/kfirs/deployster-k8s-role:${CIRCLE_TAG}
            docker tag quay.io/kfirs/deployster-k8s-rolebinding:${CIRCLE_SHA1} quay.io/kfirs/deployster-k8s-rolebinding:${CIRCLE_TAG}
            docker tag quay.io/kfirs/deployster-k8s-secret:${CIRCLE_SHA1} quay.io/kfirs/deployster-k8s-secret:${CIRCLE_TAG}
            docker tag quay.io/kfirs/deployster-k8s-service:${CIRCLE_SHA1} quay.io/kfirs/deployster-k8s-service:${CIRCLE_TAG}
            docker tag quay.io/kfirs/deployster-k8s-serviceaccount:${CIRCLE_SHA1} quay.io/kfirs/deployster-k8s-serviceaccount:${CIRCLE_TAG}
            docker tag quay.io/kfirs/deployster-k8s-statefulset:${CIRCLE_SHA1} quay.io/kfirs/deployster-k8s-statefulset:${CIRCLE_TAG}
            docker tag quay.io/kfirs/deployster-k8s-storageclass:${CIRCLE_SHA1} quay.io/kfirs/deployster-k8s-storageclass:${CIRCLE_TAG}
            docker build -q --build-arg "VERSION=${CIRCLE_TAG}" --tag quay.io/kfirs/deployster:${CIRCLE_TAG} -f ./Dockerfile .
      - run:
          name: Build "latest" Docker images
          command: |
            docker tag quay.io/kfirs/deployster-dresource:${CIRCLE_SHA1} quay.io/kfirs/deployster-dresource:latest
            docker tag quay.io/kfirs/deployster-gcp:${CIRCLE_SHA1} quay.io/kfirs/deployster-gcp:latest
            docker tag quay.io/kfirs/deployster-gcp-cloud-sql:${CIRCLE_SHA1} quay.io/kfirs/deployster-gcp-cloud-sql:latest
            docker tag quay.io/kfirs/deployster-gcp-compute-ip-address:${CIRCLE_SHA1} quay.io/kfirs/deployster-gcp-compute-ip-address:latest
            docker tag quay.io/kfirs/deployster-gcp-gke-cluster:${CIRCLE_SHA1} quay.io/kfirs/deployster-gcp-gke-cluster:latest
            docker tag quay.io/kfirs/deployster-gcp-iam-policy:${CIRCLE_SHA1} quay.io/kfirs/deployster-gcp-iam-policy:latest
            docker tag quay.io/kfirs/deployster-gcp-iam-service-account:${CIRCLE_SHA1} quay.io/kfirs/deployster-gcp-iam-service-account:latest
            docker tag quay.io/kfirs/deployster-gcp-project:${CIRCLE_SHA1} quay.io/kfirs/deployster-gcp-project:latest
            docker tag quay.io/kfirs/deployster-k8s:${CIRCLE_SHA1} quay.io/kfirs/deployster-k8s:latest
            docker tag quay.io/kfirs/deployster-k8s-clusterrole:${CIRCLE_SHA1} quay.io/kfirs/deployster-k8s-clusterrole:latest
            docker tag quay.io/kfirs/deployster-k8s-clusterrolebinding:${CIRCLE_SHA1} quay.io/kfirs/deployster-k8s-clusterrolebinding:latest
            docker tag quay.io/kfirs/deployster-k8s-configmap:${CIRCLE_SHA1} quay.io/kfirs/deployster-k8s-configmap:latest
            docker tag quay.io/kfirs/deployster-k8s-cronjob:${CIRCLE_SHA1} quay.io/kfirs/deployster-k8s-cronjob:latest
            docker tag quay.io/kfirs/deployster-k8s-daemonset:${CIRCLE_SHA1} quay.io/kfirs/deployster-k8s-daemonset:latest
            docker tag quay.io/kfirs/deployster-k8s-deployment:${CIRCLE_SHA1} quay.io/kfirs/deployster-k8s-deployment:latest
            docker tag quay.io/kfirs/deployster-k8s-horizontalpodautoscaler:${CIRCLE_SHA1} quay.io/kfirs/deployster-k8s-horizontalpodautoscaler:latest
            docker tag quay.io/kfirs/deployster-k8s-ingress:${CIRCLE_SHA1} quay.io/kfirs/deployster-k8s-ingress:latest
            docker tag quay.io/kfirs/deployster-k8s-job:${CIRCLE_SHA1} quay.io/kfirs/deployster-k8s-job:latest
            docker tag quay.io/kfirs/deployster-k8s-namespace:${CIRCLE_SHA1} quay.io/kfirs/deployster-k8s-namespace:latest
            docker tag quay.io/kfirs/deployster-k8s-networkpolicy:${CIRCLE_SHA1} quay.io/kfirs/deployster-k8s-networkpolicy:latest
            docker tag quay.io/kfirs/deployster-k8s-node:${CIRCLE_SHA1} quay.io/kfirs/deployster-k8s-node:latest
            docker tag quay.io/kfirs/deployster-k8s-persistentvolume:${CIRCLE_SHA1} quay.io/kfirs/deployster-k8s-persistentvolume:latest
            docker tag quay.io/kfirs/deployster-k8s-persistentvolumeclaim:${CIRCLE_SHA1} quay.io/kfirs/deployster-k8s-persistentvolumeclaim:latest
            docker tag quay.io/kfirs/deployster-k8s-pod:${CIRCLE_SHA1} quay.io/kfirs/deployster-k8s-pod:latest
            docker tag quay.io/kfirs/deployster-k8s-replicaset:${CIRCLE_SHA1} quay.io/kfirs/deployster-k8s-replicaset:latest
            docker tag quay.io/kfirs/deployster-k8s-replicationcontroller:${CIRCLE_SHA1} quay.io/kfirs/deployster-k8s-replicationcontroller:latest
            docker tag quay.io/kfirs/deployster-k8s-role:${CIRCLE_SHA1} quay.io/kfirs/deployster-k8s-role:latest
            docker tag quay.io/kfirs/deployster-k8s-rolebinding:${CIRCLE_SHA1} quay.io/kfirs/deployster-k8s-rolebinding:latest
            docker tag quay.io/kfirs/deployster-k8s-secret:${CIRCLE_SHA1} quay.io/kfirs/deployster-k8s-secret:latest
            docker tag quay.io/kfirs/deployster-k8s-service:${CIRCLE_SHA1} quay.io/kfirs/deployster-k8s-service:latest
            docker tag quay.io/kfirs/deployster-k8s-serviceaccount:${CIRCLE_SHA1} quay.io/kfirs/deployster-k8s-serviceaccount:latest
            docker tag quay.io/kfirs/deployster-k8s-statefulset:${CIRCLE_SHA1} quay.io/kfirs/deployster-k8s-statefulset:latest
            docker tag quay.io/kfirs/deployster-k8s-storageclass:${CIRCLE_SHA1} quay.io/kfirs/deployster-k8s-storageclass:latest
            docker tag quay.io/kfirs/deployster:${CIRCLE_SHA1} quay.io/kfirs/deployster:latest
      - run:
          name: Push versioned Docker images
          command: |
            docker push quay.io/kfirs/deployster-dresource:${CIRCLE_TAG} &
            docker push quay.io/kfirs/deployster-gcp:${CIRCLE_TAG} &
            docker push quay.io/kfirs/deployster-gcp-cloud-sql:${CIRCLE_TAG} &
            docker push quay.io/kfirs/deployster-gcp-compute-ip-address:${CIRCLE_TAG} &
            docker push quay.io/kfirs/deployster-gcp-gke-cluster:${CIRCLE_TAG} &
            docker push quay.io/kfirs/deployster-gcp-iam-policy:${CIRCLE_TAG} &
            docker push quay.io/kfirs/deployster-gcp-iam-service-account:${CIRCLE_TAG} &
            docker push quay.io/kfirs/deployster-gcp-project:${CIRCLE_TAG} &
            docker push quay.io/kfirs/deployster-k8s:${CIRCLE_TAG} &
            docker push quay.io/kfirs/deployster-k8s-clusterrole:${CIRCLE_TAG} &
            docker push quay.io/kfirs/deployster-k8s-clusterrolebinding:${CIRCLE_TAG} &
            docker push quay.io/kfirs/deployster-k8s-configmap:${CIRCLE_TAG} &
            docker push quay.io/kfirs/deployster-k8s-cronjob:${CIRCLE_TAG} &
            docker push quay.io/kfirs/deployster-k8s-daemonset:${CIRCLE_TAG} &
            docker push quay.io/kfirs/deployster-k8s-deployment:${CIRCLE_TAG} &
            docker push quay.io/kfirs/deployster-k8s-horizontalpodautoscaler:${CIRCLE_TAG} &
            docker push quay.io/kfirs/deployster-k8s-ingress:${CIRCLE_TAG} &
            docker push quay.io/kfirs/deployster-k8s-job:${CIRCLE_TAG} &
            docker push quay.io/kfirs/deployster-k8s-namespace:${CIRCLE_TAG} &
            docker push quay.io/kfirs/deployster-k8s-networkpolicy:${CIRCLE_TAG} &
            docker push quay.io/kfirs/deployster-k8s-node:${CIRCLE_TAG} &
            docker push quay.io/kfirs/deployster-k8s-persistentvolume:${CIRCLE_TAG} &
            docker push quay.io/kfirs/deployster-k8s-persistentvolumeclaim:${CIRCLE_TAG} &
            docker push quay.io/kfirs/deployster-k8s-pod:${CIRCLE_TAG} &
            docker push quay.io/kfirs/deployster-k8s-replicaset:${CIRCLE_TAG} &
            docker push quay.io/kfirs/deployster-k8s-replicationcontroller:${CIRCLE_TAG} &
            docker push quay.io/kfirs/deployster-k8s-role:${CIRCLE_TAG} &
            docker push quay.io/kfirs/deployster-k8s-rolebinding:${CIRCLE_TAG} &
            docker push quay.io/kfirs/deployster-k8s-secret:${CIRCLE_TAG} &
            docker push quay.io/kfirs/deployster-k8s-service:${CIRCLE_TAG} &
            docker push quay.io/kfirs/deployster-k8s-serviceaccount:${CIRCLE_TAG} &
            docker push quay.io/kfirs/deployster-k8s-statefulset:${CIRCLE_TAG} &
            docker push quay.io/kfirs/deployster-k8s-storageclass:${CIRCLE_TAG} &
            docker push quay.io/kfirs/deployster:${CIRCLE_TAG} &
            wait
      - run:
          name: Push "latest" Docker images
          command: |
            docker push quay.io/kfirs/deployster-dresource:latest &
            docker push quay.io/kfirs/deployster-gcp:latest &
            docker push quay.io/kfirs/deployster-gcp-cloud-sql:latest &
            docker push quay.io/kfirs/deployster-gcp-compute-ip-address:latest &
            docker push quay.io/kfirs/deployster-gcp-gke-cluster:latest &
            docker push quay.io/kfirs/deployster-gcp-iam-policy:latest &
            docker push quay.io/kfirs/deployster-gcp-iam-service-account:latest &
            docker push quay.io/kfirs/deployster-gcp-project:latest &
            docker push quay.io/kfirs/deployster-k8s:latest &
            docker push quay.io/kfirs/deployster-k8s-clusterrole:latest &
            docker push quay.io/kfirs/deployster-k8s-clusterrolebinding:latest &
            docker push quay.io/kfirs/deployster-k8s-configmap:latest &
            docker push quay.io/kfirs/deployster-k8s-cronjob:latest &
            docker push quay.io/kfirs/deployster-k8s-daemonset:latest &
            docker push quay.io/kfirs/deployster-k8s-deployment:latest &
            docker push quay.io/kfirs/deployster-k8s-horizontalpodautoscaler:latest &
            docker push quay.io/kfirs/deployster-k8s-ingress:latest &
            docker push quay.io/kfirs/deployster-k8s-job:latest &
            docker push quay.io/kfirs/deployster-k8s-namespace:latest &
            docker push quay.io/kfirs/deployster-k8s-networkpolicy:latest &
            docker push quay.io/kfirs/deployster-k8s-node:latest &
            docker push quay.io/kfirs/deployster-k8s-persistentvolume:latest &
            docker push quay.io/kfirs/deployster-k8s-persistentvolumeclaim:latest &
            docker push quay.io/kfirs/deployster-k8s-pod:latest &
            docker push quay.io/kfirs/deployster-k8s-replicaset:latest &
            docker push quay.io/kfirs/deployster-k8s-replicationcontroller:latest &
            docker push quay.io/kfirs/deployster-k8s-role:latest &
            docker push quay.io/kfirs/deployster-k8s-rolebinding:latest &
            docker push quay.io/kfirs/deployster-k8s-secret:latest &
            docker push quay.io/kfirs/deployster-k8s-service:latest &
            docker push quay.io/kfirs/deployster-k8s-serviceaccount:latest &
            docker push quay.io/kfirs/deployster-k8s-statefulset:latest &
            docker push quay.io/kfirs/deployster-k8s-storageclass:latest &
            docker push quay.io/kfirs/deployster:latest &
            wait
workflows:
  version: 2
  test_and_build:
    jobs:
      - test:
          context: org-global
      - build:
          context: org-global
  release:
    jobs:
      - release:
          context: org-global
          filters:
            tags:
              only: /^\d+\.\d+\.\d+$/
            branches:
              ignore: /.*/
